# Module 4: Processing Big Data

- [Module 4: Processing Big Data](#module-4-processing-big-data)
    - [Demo 1: Using a Transformation Function to Calculate a Running Total](#demo-1-using-a-transformation-function-to-calculate-a-running-total)
        - [Scenario](#scenario)
        - [Preparation](#preparation)
        - [Creating a transformation function](#creating-a-transformation-function)
        - [Testing the transformation function](#testing-the-transformation-function)
        - [Viewing the results of the transformation](#viewing-the-results-of-the-transformation)
    - [Demo 2: Sorting Data with rxSort](#demo-2-sorting-data-with-rxsort)
        - [Scenario](#scenario)
        - [Preparation](#preparation)
        - [Tuning a Sort](#tuning-a-sort)
        - [Removing Duplicates from Sorted Data](#removing-duplicates-from-sorted-data)

## Demo 1: Using a Transformation Function to Calculate a Running Total

### Scenario

In this demonstration, you will see how to add a new column to the flight delay data that contains a running total of all the flight distances.

### Preparation

1. Log in to the  VM as **.\\student** with the password **Pa55w.rd**.
2. Using **File Explorer**, move to the folder **E:\\Demofiles\\Mod04**, and then double-click the file **FlightDelayData.part01.exe**
3. In the **WinRAR self-extracting archive** dialog box, click **Extract**.
4. Open a command prompt window.
5. Run the following commands:

    ```CMD
    
    copy E:\Demofiles\Mod04\FlightDelayData.xdf E:\Data
    ```

   Overwrite the file if necessary, and verify that the file is copied successfully.

6. Close the command prompt.

### Creating a transformation function

1. Open your R development environment of choice (RStudio or Visual Studio 2017®).
2. Open the R script **Demo1 - tranformations.R** in the **E:\\Demofiles\\Mod04** folder.
3. Highlight and run the code under the comment **# Connect to R Server**. This code connects to R Server running on the LON-RSVR VM.
4. Highlight and run the code under the comment **# Examine the dataset**. This code shows the structure of the sample data and displays the first 10 rows. Note that the data contains 29 variables.
5. Highlight and run the entire block of code that creates the **addRunningTotal** function, under the comment **# Create the transformation function**. This function performs the following tasks:

    - It checks to see whether this is a test pass over a chunk, and if so it returns immediately.
    - It retrieves the value of the **runningTotal** variable from the environment (this variable will be initialized to 0 by the **rxDataStep** function).
    - It adds a new vector to the **dataList** list. This vector will add the data for the new column containing the running total. The column is named **RunningTotal**.
    - It iterates through the values in the vector for the Distance variable, generates the running total, and adds the total for each row to the **RunningTotal** vector.
    - After completing its work, the function saves the current value of the **runningTotal** variable to the environment.
    - It returns the updated **dataList** list that now includes the **RunningTotal** vector. This vector will be added as a variable to the dataset.

### Testing the transformation function

1. Highlight and run the code under the comment **# Run the transformation**. This code uses **rxDataStep** to run the transformation function. Note the following points:

    - The **transformFunc** argument is set to **addRunningTotal**. This is the name of the transformation function.
    - The **transformVars** argument specifies the **Distance** variable.
    - The **transformObjects** argument creates and initializes the **runningTotal** environment variable.
    - The **numRows** argument limits the operation to the first 2 million rows. It is always best to test transformations on a subset of your data first.
    - The transforms list also adds a variable named **ObservationNum** to the data. This variable holds the row number. It is generated by using a range based on the **.rxStartRow** and **.rxNumRows** special variables.
  
2. As the function runs, note the progress messages that are reported, listing the time taken to process each chunk.

### Viewing the results of the transformation

1. Highlight and run the code under the comment **# View the results**. This code retrieves the metadata for the transformed XDF file and displays the first few rows and the last few rows. Notice that the **RunningTotal** variable has been added.
2. Highlight and run the code under the comment **# Plot a line to visualize the results using a random sample of the data**. This statement creates a line plot over a sample of the data, showing how the **RunningTotal** variable increases with the number of observations.
3. Close your R development environment of choice (RStudio or Visual Studio 2017).

## Demo 2: Sorting Data with rxSort

### Scenario

In this demonstration, you will see how use the **rxSort** function to tune the sorting process and remove duplicates from sorted data.

### Preparation

1. Start the **20773A-LON-DC**, **20773A-LON-DEV**, **20773A-LON-SQLR**, **20773A-LON-RSVR**, and **MT17B-WS2016-NAT** VMs if they are not already running.
2. Log in to the  VM as **.\\student** with the password **Pa55w.rd**.
3. Using **File Explorer**, move to the folder **E:\\Demofiles\\Mod04**, and then double-click the file **FlightDelayData.part01.exe**
4. In the **WinRAR self-extracting archive** dialog box, click **Extract**. Overwrite the existing file if prompted.
5. Open a command prompt window.
6. Run the following commands:

    ```CMD
    
    copy E:\Demofiles\Mod04\FlightDelayData.xdf E:\Data
    ```

   Overwrite the file if necessary, and verify that the file is copied successfully.

7. Close the command prompt.

### Tuning a Sort

1. Open your R development environment of choice (RStudio or Visual Studio 2017).
2. Open the R script **Demo2 - sorting.R** in the **E:\\Demofiles\\Mod04** folder.
3. Highlight and run the code under the comment **# Connect to R Server**. This code connects to R Server running on the LON-RSVR VM.
4. Highlight and run the code under the comment **# Examine the data**. This code shows the first few rows from the flight delay data.
5. Highlight and run the code under the comment **# Sort it by Origin**. This code sorts the data by the **Origin** variable, in decreasing order. This process can take up to 120 seconds.
6. Highlight and run the code under the comment **# Note the factor levels for Origin**. This code displays the factor levels for the **Origin** variable. This is the sequence in which the data should be sorted. Note that the final three levels are **MKG**, **LMT**, and **OTH**.
7. Highlight and run the code under the comment **# View the data**. It should be sorted in descending order of **Origin**. This statement displays the first 200 rows of the data. Note that the data for **OTH** appears first, followed by **LMT**, and then **MKG**.
8. Highlight and run the code under the comment **# Sort the data again**. This statement sorts a dataset containing a much smaller number of variables. The sort should be much quicker. This shows the importance of being selective when sorting a dataset.
9. Highlight and run the code under the comment **# View the data**. The data should still be sorted by **Origin**.

### Removing Duplicates from Sorted Data

1. Highlight and run the code under the comment **# De-dup routes**. This code sorts the data by **Origin**, but only selects the **Origin**, **Dest**, and **Distance** variables. The **removeDupKeys** argument removes any duplicates. The number of occurrences of each set of these variables is recorded in the **RoutesFrequency** variable which is added to the results.
2. Highlight and run the code under the comment **# View the data**. The data now only contains the **Origin**, **Dest**, and **Distance** variables, together with **RoutesFrequency**, indicating how many times each route was found in the original data.
3. Close your R development environment of choice (RStudio or Visual Studio 2017).

---

©2018 Microsoft Corporation. All rights reserved.

The text in this document is available under the [Creative Commons Attribution 3.0 License](https://creativecommons.org/licenses/by/3.0/legalcode), additional terms may apply. All other content contained in this document (including, without limitation, trademarks, logos, images, etc.) are **not** included within the Creative Commons license grant. This document does not provide you with any legal rights to any intellectual property in any Microsoft product. You may copy and use this document for your internal, reference purposes.

This document is provided "as-is." Information and views expressed in this document, including URL and other Internet Web site references, may change without notice. You bear the risk of using it. Some examples are for illustration only and are fictitious. No real association is intended or inferred. Microsoft makes no warranties, express or implied, with respect to the information provided here.
